<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit-no"
    />
    <title>S0LACE • TV Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <!-- BareMux + Epoxy for Scramjet backend -->
    <script src="baremux/index.js"></script>
    <script src="epoxy/index.js"></script>

    <!-- Service worker + global stuff -->
    <script src="register-sw.js" defer></script>
    <script src="global-hub.js" defer></script>

    <style>
      /* === LAYOUT JUST FOR TV PLAYER === */
      body.media-tv-page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .tv-main-layout {
        flex: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 10px 18px;
        display: grid;
        grid-template-columns: minmax(0, 3.5fr) minmax(260px, 1.4fr);
        gap: 40px; /* more separation like your sketch */
        align-items: flex-start;
      }

      .tv-left {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 0;
      }

      .tv-right {
        background: var(--panel, #050505);
        border: 2px solid var(--border-hard, #262626);
        box-shadow: 0 0 0 1px #000, 0 0 24px rgba(0, 0, 0, 0.85);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 0;
      }

      .tv-sidebar-title {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--accent, #00ff7f);
        margin-bottom: 2px;
      }

      .tv-sidebar-sub {
        font-size: 8px;
        color: var(--fg-dim, #7f7f7f);
        margin-bottom: 6px;
      }

      .tv-season-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .tv-season-row label {
        font-size: 8px;
        color: var(--fg-dim, #7f7f7f);
        white-space: nowrap;
      }

      #season-select {
        flex: 1;
        font-size: 9px;
        font-family: "Press Start 2P", system-ui, sans-serif;
        background: #000;
        border: 2px solid var(--border-hard, #262626);
        color: var(--fg, #f5f5f5);
        padding: 4px 6px;
        outline: none;
      }

      #season-select:focus {
        border-color: var(--accent, #00ff7f);
        box-shadow: 0 0 0 1px #000, 0 0 12px rgba(0, 255, 127, 0.5);
      }

      .tv-episodes {
        flex: 1;
        border: 1px solid #202020;
        background: #020202;
        padding: 4px;
        overflow-y: auto;
        font-size: 8px;
        min-height: 200px;
      }

      .tv-episode-btn {
        width: 100%;
        text-align: left;
        border: 1px solid transparent;
        background: transparent;
        color: var(--fg, #f5f5f5);
        font-family: "Press Start 2P", system-ui, sans-serif;
        font-size: 8px;
        padding: 4px 5px;
        margin-bottom: 3px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }

      .tv-episode-btn:hover {
        border-color: var(--accent, #00ff7f);
        background: rgba(0, 255, 127, 0.1);
      }

      .tv-episode-btn.active {
        border-color: var(--accent, #00ff7f);
        background: rgba(0, 255, 127, 0.2);
        color: var(--accent, #00ff7f);
      }

      .tv-ep-code {
        white-space: nowrap;
      }

      .tv-ep-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        opacity: 0.9;
      }

      .tv-bottom-note {
        font-size: 7px;
        color: var(--fg-dim, #7f7f7f);
        margin-top: 3px;
      }

      .player-main.tv-player-main {
        padding: 0;
      }

      .player-info {
        font-size: 9px;
        padding: 0 2px 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .player-left {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* BIG HORIZONTAL 16:10 FRAME */
      .player-frame-wrap {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 10; /* 16:10 */
        border: 2px solid var(--border-hard, #262626);
        background: #020617;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.9);
        overflow: hidden;
      }

      .player-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-size: 9px;
        color: var(--fg-dim, #7f7f7f);
        background: radial-gradient(
          circle at top,
          rgba(0, 0, 0, 0.95),
          rgba(0, 0, 0, 0.98)
        );
        z-index: 2;
        text-align: center;
        padding: 16px;
      }

      .player-loading span {
        margin-top: 6px;
        opacity: 0.7;
      }

      #tv-frame {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border: none;
      }

      .tv-meta {
        font-size: 8px;
        color: var(--fg-dim, #7f7f7f);
        padding: 4px 2px 0;
        line-height: 1.6;
      }

      .tv-meta span {
        color: var(--accent, #00ff7f);
      }

      .player-actions button,
      .player-actions a {
        font-size: 8px;
        border-radius: 0;
        border: 2px solid var(--border-hard, #262626);
        background: #000;
        color: var(--fg, #f5f5f5);
        padding: 3px 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .player-actions button:hover,
      .player-actions a:hover {
        border-color: var(--accent, #00ff7f);
        color: var(--accent, #00ff7f);
        box-shadow: 0 0 14px rgba(0, 255, 127, 0.5);
      }

      @media (max-width: 900px) {
        .tv-main-layout {
          grid-template-columns: minmax(0, 1fr);
          gap: 20px;
        }
        .tv-right {
          order: -1; /* sidebar on top on small screens */
        }
      }
    </style>
  </head>

  <body class="media-tv-page">
    <header class="site-header">
      <div class="site-title">S0LACE</div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="media.html" class="active">Media</a>
        <a href="apps.html">Apps</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main class="player-main tv-player-main">
      <div class="tv-main-layout">
        <!-- LEFT: big TV iframe + text -->
        <section class="tv-left">
          <div class="player-info">
            <div class="player-left">
              <span id="player-title">Loading…</span>
            </div>
            <div class="player-actions">
              <a href="media.html">← BACK TO MEDIA</a>
              <button id="open-new-tab">OPEN IN NEW TAB</button>
            </div>
          </div>

          <div class="player-frame-wrap">
            <div id="player-loading" class="player-loading">
              CONNECTING TO PROXY…
              </span>
            </div>

            <iframe
              id="tv-frame"
              src="about:blank"
              allowfullscreen
              allow="fullscreen; picture-in-picture; encrypted-media"
            ></iframe>
          </div>

          <div class="tv-meta">
            <div id="tv-meta-main">
              <span>Series:</span> <span id="tv-series-name">Loading…</span>
            </div>
            <div id="tv-meta-sep">
              <span>Now playing:</span>
              <span id="tv-current-label">S1 · E1</span>
            </div>
          </div>
        </section>

        <!-- RIGHT: season + episodes panel -->
        <aside class="tv-right">
          <div class="tv-sidebar-title">Seasons & Episodes</div>
          </div>

          <div class="tv-season-row">
            <label for="season-select">SEASON</label>
            <select id="season-select"></select>
          </div>

          <div id="tv-episodes" class="tv-episodes">
            <!-- episode buttons injected here -->
          </div>

          <div class="tv-bottom-note">
            If an episode fails to load, the host might be missing it or down.
          </div>
        </aside>
      </div>

      <div id="player-error" class="no-src" style="display: none;">
        No TV ID provided.
      </div>
    </main>

    <script>
      (async () => {
        // ===== URL PARAMS =====
        const params = new URLSearchParams(window.location.search);
        const tmdbId = params.get("id");
        const titleParam = params.get("title") || "Untitled Series";
        let currentSeason = parseInt(params.get("season") || "1", 10) || 1;
        let currentEpisode = parseInt(params.get("episode") || "1", 10) || 1;

        // ===== CONSTANTS =====
        const TMDB_KEY = "2d1351cf74f73892042699d0431b799a";
        const TMDB_BASE = "https://api.themoviedb.org/3";

        // ===== DOM =====
        const frame = document.getElementById("tv-frame");
        const titleEl = document.getElementById("player-title");
        const errorEl = document.getElementById("player-error");
        const loadingEl = document.getElementById("player-loading");
        const loadingSub = document.getElementById("player-loading-sub");
        const openNewTabBtn = document.getElementById("open-new-tab");
        const seasonSelect = document.getElementById("season-select");
        const episodesBox = document.getElementById("tv-episodes");
        const seriesNameEl = document.getElementById("tv-series-name");
        const currentLabelEl = document.getElementById("tv-current-label");

        if (titleEl) titleEl.textContent = titleParam;

        if (!tmdbId) {
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent = "No TV series ID provided.";
          }
          return;
        }

        // OPEN IN NEW TAB (direct CinemaOS link, not proxied)
        if (openNewTabBtn) {
          openNewTabBtn.addEventListener("click", () => {
            const direct = `https://cinemaos.tech/player/${tmdbId}/${currentSeason}/${currentEpisode}`;
            window.open(direct, "_blank");
          });
        }

        // INIT BAREMUX TRANSPORT FOR SCRAMJET
        try {
          const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
          const wispUrl =
            (location.protocol === "https:" ? "wss" : "ws") +
            "://" +
            location.host +
            "/wisp/";
          if ((await connection.getTransport()) !== "/epoxy/index.mjs") {
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          }
          console.log("BareMux transport ready in TV player tab");
        } catch (err) {
          console.error("BareMux init failed (TV player)", err);
          if (loadingSub) {
            loadingSub.textContent =
              "Proxy transport failed to init. Some hosts might break.";
          }
        }

        // UPDATE FRAME SRC + LABEL  — **USING /scramjet/**
        function updateFrame() {
          const src = `/scramjet/https://cinemaos.tech/player/${tmdbId}/${currentSeason}/${currentEpisode}`;
          if (frame) {
            frame.src = src;
          }
          if (currentLabelEl) {
            currentLabelEl.textContent = `S${currentSeason} · E${currentEpisode}`;
          }
          if (titleEl) {
            titleEl.textContent = `${titleParam} — S${currentSeason} · E${currentEpisode}`;
          }
        }

        // Loading timeouts
        let longTimeout = setTimeout(() => {
          if (loadingSub) {
            loadingSub.textContent =
              "This is taking longer than usual. The host or proxy might be slow.";
          }
        }, 8000);

        let hardTimeout = setTimeout(() => {
          if (loadingEl) loadingEl.style.display = "none";
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent =
              "The TV stream did not finish loading. It might be blocked or missing.";
          }
        }, 25000);

        if (frame) {
          frame.addEventListener("load", () => {
            if (loadingEl) loadingEl.style.display = "none";
            clearTimeout(longTimeout);
            clearTimeout(hardTimeout);
          });
        }

        // TMDB: LOAD SERIES + SEASONS
        async function loadSeriesAndSeasons() {
          try {
            const res = await fetch(
              `${TMDB_BASE}/tv/${tmdbId}?api_key=${TMDB_KEY}&language=en-US`
            );
            const data = await res.json();

            if (seriesNameEl) {
              seriesNameEl.textContent = data.name || titleParam;
            }

            const seasons = (data.seasons || []).filter(
              (s) => s.season_number && s.episode_count > 0
            );

            seasonSelect.innerHTML = "";
            seasons
              .sort((a, b) => a.season_number - b.season_number)
              .forEach((s) => {
                const opt = document.createElement("option");
                opt.value = s.season_number;
                opt.textContent = `Season ${s.season_number}`;
                if (s.season_number === currentSeason) opt.selected = true;
                seasonSelect.appendChild(opt);
              });

            if (!seasons.some((s) => s.season_number === currentSeason)) {
              currentSeason = seasons[0]?.season_number || 1;
            }
          } catch (err) {
            console.error("Failed to load TV info from TMDB", err);
          }
        }

        // TMDB: LOAD EPISODES FOR CURRENT SEASON
        async function loadEpisodesForSeason(seasonNum) {
          try {
            const res = await fetch(
              `${TMDB_BASE}/tv/${tmdbId}/season/${seasonNum}?api_key=${TMDB_KEY}&language=en-US`
            );
            const data = await res.json();
            const episodes = data.episodes || [];

            episodesBox.innerHTML = "";

            episodes.forEach((ep) => {
              const btn = document.createElement("button");
              btn.className = "tv-episode-btn";
              btn.dataset.episodeNumber = ep.episode_number;

              const code = document.createElement("span");
              code.className = "tv-ep-code";
              code.textContent = `E${ep.episode_number}`;

              const name = document.createElement("span");
              name.className = "tv-ep-name";
              name.textContent = ep.name || "Episode";

              btn.appendChild(code);
              btn.appendChild(name);

              if (ep.episode_number === currentEpisode) {
                btn.classList.add("active");
              }

              btn.addEventListener("click", () => {
                currentSeason = seasonNum;
                currentEpisode = ep.episode_number;
                document
                  .querySelectorAll(".tv-episode-btn")
                  .forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                updateFrame();
              });

              episodesBox.appendChild(btn);
            });

            if (!episodes.some((ep) => ep.episode_number === currentEpisode)) {
              currentEpisode = episodes[0]?.episode_number || 1;
              const firstBtn = episodesBox.querySelector(".tv-episode-btn");
              if (firstBtn) firstBtn.classList.add("active");
            }
          } catch (err) {
            console.error("Failed to load episodes for season", seasonNum, err);
          }
        }

        // HOOKS
        seasonSelect.addEventListener("change", async () => {
          const newSeason = parseInt(seasonSelect.value, 10) || 1;
          currentSeason = newSeason;
          currentEpisode = 1; // default to ep1 on season change
          await loadEpisodesForSeason(currentSeason);
          updateFrame();
        });

        // INITIAL LOAD
        await loadSeriesAndSeasons();
        await loadEpisodesForSeason(currentSeason);
        updateFrame();
      })();
    </script>
  </body>
</html>
