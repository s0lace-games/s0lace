<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S0LACE • Media Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <!-- BareMux + Epoxy (required by Scramjet) -->
    <script src="baremux/index.js"></script>
    <script src="epoxy/index.js"></script>

    <!-- Service worker + global scripts -->
    <script src="register-sw.js" defer></script>
    <script src="global-hub.js" defer></script>

    <!-- Player local styles -->
    <style>
      .player-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-size: 9px;
        color: var(--fg-dim);
        background: radial-gradient(
          circle at top,
          rgba(0, 0, 0, 0.95),
          rgba(0, 0, 0, 0.98)
        );
        z-index: 2;
        text-align: center;
        padding: 16px;
      }
      .player-loading span {
        margin-top: 6px;
        opacity: 0.7;
      }

      /* space for TV sidebar */
      .player-frame-wrap {
        position: relative;
        margin-right: 260px;
      }

      /* TV SIDEBAR */
      .tv-sidebar {
        position: absolute;
        right: 0;
        top: 0;
        width: 260px;
        height: 100%;
        background: rgba(10, 10, 10, 0.95);
        border-left: 1px solid var(--stroke);
        padding: 16px;
        overflow-y: auto;
        display: none;
        z-index: 3;
      }

      .tv-sidebar h3 {
        margin: 0 0 10px;
        font-size: 13px;
        color: var(--fg);
      }

      .tv-sidebar select {
        width: 100%;
        margin-bottom: 12px;
        padding: 6px;
        background: #111;
        color: var(--fg);
        border: 1px solid #333;
        border-radius: 5px;
      }

      .tv-sidebar button {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        background: var(--accent);
        border: none;
        color: black;
        font-weight: 600;
        cursor: pointer;
        border-radius: 8px;
      }
    </style>
  </head>

  <body class="media-player-page">
    <header class="site-header">
      <div class="site-title">S0LACE</div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="media.html" class="active">Media</a>
        <a href="apps.html">Apps</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main class="player-main">
      <div class="player-info">
        <div class="player-left">
          <span id="player-title">Loading…</span>
        </div>
        <div class="player-actions">
          <a href="media.html">← BACK TO MEDIA</a>
          <button id="open-new-tab">OPEN IN NEW TAB</button>
        </div>
      </div>

      <div class="player-frame-wrap">
        <!-- Loading overlay -->
        <div id="player-loading" class="player-loading">
          CONNECTING TO PROXY…
          <span id="player-loading-sub">
            If this takes more than a few seconds, the media host or proxy might be slow.
          </span>
        </div>

        <!-- Actual player iframe -->
        <iframe
          id="media-frame"
          src="about:blank"
          allowfullscreen
          allow="fullscreen; picture-in-picture; encrypted-media"
        ></iframe>
      </div>

      <!-- TV Sidebar -->
      <div class="tv-sidebar" id="tv-sidebar">
        <h3>TV Episodes</h3>

        <label>Season</label>
        <select id="tv-season"></select>

        <label>Episode</label>
        <select id="tv-episode"></select>

        <button id="tv-load">LOAD EPISODE</button>
      </div>

      <div id="player-error" class="no-src" style="display:none;">
        No media URL provided.
      </div>
    </main>

    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);

        const type  = params.get("type");   // movie | show
        const id    = params.get("id");
        const title = params.get("title") || "Untitled";

        const frame = document.getElementById("media-frame");
        const titleEl = document.getElementById("player-title");
        const errorEl = document.getElementById("player-error");
        const frameWrap = document.querySelector(".player-frame-wrap");
        const openNewTabBtn = document.getElementById("open-new-tab");
        const loadingEl = document.getElementById("player-loading");
        const loadingSub = document.getElementById("player-loading-sub");

        // Sidebar refs
        const tvSidebar = document.getElementById("tv-sidebar");
        const tvSeason = document.getElementById("tv-season");
        const tvEpisode = document.getElementById("tv-episode");
        const tvLoad = document.getElementById("tv-load");

        titleEl.textContent = title;

        // Build src
        let src = params.get("src");

        if (!src && type && id) {
          if (type === "movie") {
            src = `/scramjet/https://cinemaos.live/player/${id}`;
            tvSidebar.style.display = "none";
          }
          if (type === "show") {
            src = `/scramjet/https://cinemaos.live/tv/${id}/1/1`;
            tvSidebar.style.display = "block";
          }
        }

        if (!src) {
          frameWrap.style.display = "none";
          errorEl.style.display = "flex";
          errorEl.textContent = "No media URL provided.";
          return;
        }

        openNewTabBtn.addEventListener("click", () => window.open(src, "_blank"));

        // Setup BareMux/Epoxy transport
        try {
          const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
          const wispUrl =
            (location.protocol === "https:" ? "wss" : "ws") +
            "://" + location.host + "/wisp/";

          if ((await connection.getTransport()) !== "/epoxy/index.mjs") {
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          }
        } catch (err) {
          console.error(err);
          loadingSub.textContent = "Transport failed — the page may still load.";
        }

        // Loading timeouts
        let longTimeout = setTimeout(() => {
          loadingSub.textContent =
            "Slow response — proxy or host may be lagging.";
        }, 8000);

        let hardTimeout = setTimeout(() => {
          loadingEl.style.display = "none";
          errorEl.style.display = "flex";
          errorEl.textContent =
            "Media failed to finish loading. It may be blocked or offline.";
        }, 25000);

        // Frame load handler
        frame.addEventListener("load", () => {
          loadingEl.style.display = "none";
          clearTimeout(longTimeout);
          clearTimeout(hardTimeout);
        });

        frame.src = src;

        // ===== TV SHOW MODE =====
        if (type === "show") {
          const tmdbKey = "2d1351cf74f73892042699d0431b799a";

          // Fetch seasons
          const tvData = await fetch(
            `https://api.themoviedb.org/3/tv/${id}?api_key=${tmdbKey}&language=en-US`
          ).then(r => r.json());

          // Season list
          tvData.seasons.forEach(s => {
            if (s.season_number === 0) return;
            const opt = document.createElement("option");
            opt.value = s.season_number;
            opt.textContent = "Season " + s.season_number;
            tvSeason.appendChild(opt);
          });

          // When season changes → load episodes
          tvSeason.addEventListener("change", async () => {
            const seasonNum = tvSeason.value;
            tvEpisode.innerHTML = "";

            const seasonInfo = await fetch(
              `https://api.themoviedb.org/3/tv/${id}/season/${seasonNum}?api_key=${tmdbKey}&language=en-US`
            ).then(r => r.json());

            seasonInfo.episodes.forEach(ep => {
              const opt = document.createElement("option");
              opt.value = ep.episode_number;
              opt.textContent = `Episode ${ep.episode_number}: ${ep.name}`;
              tvEpisode.appendChild(opt);
            });
          });

          // Load first season
          tvSeason.dispatchEvent(new Event("change"));

          // Load selected episode
          tvLoad.addEventListener("click", () => {
            const season = tvSeason.value;
            const ep = tvEpisode.value;
            const newSrc = `/scramjet/https://cinemaos.live/tv/${id}/${season}/${ep}`;
            frame.src = newSrc;
          });
        }
      })();
    </script>
  </body>
</html>
